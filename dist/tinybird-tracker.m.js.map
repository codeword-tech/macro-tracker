{"version":3,"file":"tinybird-tracker.m.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = (function () {\n  var TRACKER_COLUMNS = 14\n  var COOKIE_NAME = '_track'\n  var LOCAL_STORAGE = this.localStorage\n  var STORAGE_ITEM = 'tinybird_events'\n  var DATASOURCE_NAME = 'tracker'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 2000\n  var DEFAULT_FUNCTION_NAME = 'tbt'\n  var HOST = 'https://api.tinybird.co'\n\n  var token\n  var accountName\n  var datasourceName\n  var host\n  \n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(LOCAL_STORAGE.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted(new Date(this.tbt.l))\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n  \n  function init() {\n    var args = Array.prototype.slice.call(arguments)\n\n    if (!args[0][0]) {\n      throw new Error('token is needed for sending events') \n    }\n\n    if (token) {\n      throw new Error('tracker already initialized')\n    }\n\n    token = args[0][0]\n    accountName = args[0][1] || 'main'\n    datasourceName = args[0][2] || DATASOURCE_NAME\n    host = args[0][3] || HOST\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError () {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n      \n      var url = host +\n        '/v0/datasources?mode=append&name=' + datasourceName +\n        '&token=' + token\n      var formData = new FormData()\n      formData.append('csv', rowsToCSV(events))\n\n      fetch(url, {\n        method: 'POST',\n        body: formData\n      })\n      .then(function (r) {\n        return r.json()\n      })\n      .then(function (res) {\n        if (res) {\n          events = []\n          LOCAL_STORAGE.setItem(STORAGE_ITEM, '[]')\n          delayUpload(TIMEOUT, MAX_RETRIES)\n        } else {\n          onError()\n        }\n        uploading = false\n      })\n      .catch(function () {\n        onError()\n      })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function flush() {\n    uploadEvents()\n  }\n\n  function addEvent() {\n    var argsArray = Array.prototype.slice.call(arguments)[0]\n    var ev = [\n      dateFormatted(),\n      session,\n      accountName,\n      userCookie,\n      document.location.href,\n      navigator.userAgent\n    ].concat(argsArray)\n    if (ev.length < TRACKER_COLUMNS) {\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\n    }\n    events.push(ev)\n\n    // If the event is pageload, don't wait to the flush\n    if(argsArray[0] === 'pageload') {\n      uploadEvents()\n    }\n  }\n\n  function parseItems(items) {\n    function parseItem(item) {\n      if (!Array.isArray(item)) {\n        throw new Error('Only array events are allowed')\n      }\n\n      if (!item.length) {\n        throw new Error('Event type is needed')\n      }\n\n      switch (item[0]) {\n        case 'init': \n          init(item.slice(1))\n          break;\n        case 'send': \n          addEvent(item.slice(1))\n          break;\n        case 'flush': \n          flush()\n          break;\n        default: \n          throw new Error(item[0] + ' type does not exist')\n      }\n    }\n\n    if (!Array.isArray(items)) {\n      throw new Error('Events can only be sent as an array')\n    }\n\n    for (var i = 0, l = items.length; i < l; i++) {\n      parseItem(Array.prototype.slice.call(items[i]))\n    }\n  }\n\n  function die() {\n    LOCAL_STORAGE.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  this.addEventListener('beforeunload', die)\n  this.addEventListener('unload', die, false)\n\n  // Parse first what tbt.q contains\n  parseItems(this[DEFAULT_FUNCTION_NAME].q)\n\n  // Overwritte function\n  this[DEFAULT_FUNCTION_NAME] = function () {\n    parseItems([arguments])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n  \n  /**\n   * utility methods\n   */\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function setCookie(name, value) {\n    document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0\n      var v = c == 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + \"=\"\n    var ca = document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function rowsToCSV(rows) {\n    var escapeQuotes = function (str) {\n      return str.replace(/\\\"/g, '\"\"')\n    }\n\n    return rows.map(function (r) {\n      return r.map(function (field) {\n        if (typeof(field) === 'string') {\n          field = escapeQuotes(field)\n          if (field[0] !== '\"' || field[field.length - 1] !== '\"') {\n            field = '\"' + field  + '\"'\n          }\n          return field\n        }\n        return field\n      }).join(',')\n    }).join('\\n')\n  }\n})(window)\n\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["tracker","token","accountName","datasourceName","host","LOCAL_STORAGE","this","localStorage","HOST","userCookie","name","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","Date","tbt","l","uploading","uploadEvents","n","url","formData","FormData","append","map","r","field","replace","join","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","setItem","delayUpload","onError","retries","setTimeout","parseItems","items","parseItem","item","Array","isArray","Error","args","prototype","slice","call","arguments","init","argsArray","ev","location","href","navigator","userAgent","concat","fill","addEvent","die","stringify","d","toISOString","Math","random","toString","addEventListener","q"],"mappings":"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"}