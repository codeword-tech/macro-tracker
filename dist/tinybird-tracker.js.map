{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || new URL(doc.currentScript.src).origin) +\n    '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n  var cookieDomain = getParameterByName('cookie-domain') || w.location.hostname\n  var functionName = getParameterByName('function') || 'tinybird'\n\n  if (!dataSource)\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  if (!token) throw new Error(\"'token' is required to start sending events\")\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 5000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n\n      fetch(url, {\n        method: 'POST',\n        body: rowsToNDJSON(events)\n      })\n        .then(function (r) {\n          return r.json()\n        })\n        .then(function (res) {\n          if (res) {\n            events = []\n            storage.setItem(STORAGE_ITEM, '[]')\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function addEvent(eventName, eventProps) {\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = dateFormatted()\n    ev['session_start'] = session\n    ev['uuid'] = userCookie\n\n    events.push(ev)\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n\n  // Overwritte main function\n  var queue = w[functionName] || []\n  w[functionName] = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n')\n  }\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie =\n      name + '=' + (value || '') + '; path=/' + '; domain=' + cookieDomain\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    var ca = w.document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","URL","src","origin","dataSource","token","cookieDomain","location","hostname","functionName","Error","STORAGE_ITEM","TIMEOUT","userCookie","name","nameEQ","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","addEventListener","die","queue","addEvent","apply","this","delayUpload","uploadEvents","n","onError","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","rowsToNDJSON","res","setItem","catch","retries","setTimeout","eventName","eventProps","ev","stringify","map","join","d","Date","toISOString","getAttribute","window"],"mappings":"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"}