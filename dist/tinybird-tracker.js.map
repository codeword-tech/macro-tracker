{"version":3,"file":"tinybird-tracker.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = (function () {\n  var TRACKER_COLUMNS = 14\n  var COOKIE_NAME = '_track'\n  var LOCAL_STORAGE = this.localStorage\n  var STORAGE_ITEM = 'tinybird_events'\n  var DATASOURCE_NAME = 'tracker'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 2000\n  var DEFAULT_FUNCTION_NAME = 'tbt'\n  var HOST = 'https://api.tinybird.co'\n\n  var datasourceName\n  var accountName\n  var host\n  \n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(LOCAL_STORAGE.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n  var token\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n  \n  function init() {\n    var args = Array.prototype.slice.call(arguments)\n\n    if (!args[0][0]) {\n      throw new Error('token is needed for sending events') \n    }\n\n    if (token) {\n      throw new Error('tracker already initialized')\n    }\n\n    token = args[0][0]\n    accountName = args[0][1] || 'main'\n    datasourceName = args[0][2] || DATASOURCE_NAME\n    host = args[0][3] || HOST\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError () {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n      \n      var url = host +\n        '/v0/datasources?mode=append&name=' + datasourceName +\n        '&token=' + token\n      var formData = new FormData()\n      formData.append('csv', rowsToCSV(events))\n\n      fetch(url, {\n        method: 'POST',\n        body: formData\n      })\n      .then(function (r) {\n        return r.json()\n      })\n      .then(function (res) {\n        if (res) {\n          events = []\n          LOCAL_STORAGE.setItem(STORAGE_ITEM, '[]')\n          delayUpload(TIMEOUT, MAX_RETRIES)\n        } else {\n          onError()\n        }\n        uploading = false\n      })\n      .catch(function () {\n        onError()\n      })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function flush() {\n    uploadEvents()\n  }\n\n  function addEvent() {\n    var ev = [\n      dateFormatted(),\n      session,\n      accountName,\n      userCookie,\n      document.location.href,\n      navigator.userAgent\n    ].concat(Array.prototype.slice.call(arguments)[0])\n    if (ev.length < TRACKER_COLUMNS) {\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\n    }\n    events.push(ev)\n\n    // If the event is pageload, don't wait to the flush\n    if(arguments[0] === 'pageload') {\n      uploadEvents()\n    }\n  }\n\n  function parseItems(items) {\n    function parseItem(item) {\n      if (!Array.isArray(item)) {\n        throw new Error('Only array events are allowed')\n      }\n\n      if (!item.length) {\n        throw new Error('Event type is needed')\n      }\n\n      switch (item[0]) {\n        case 'init': \n          init(item.slice(1))\n          break;\n        case 'send': \n          addEvent(item.slice(1))\n          break;\n        case 'flush': \n          flush()\n          break;\n        default: \n          throw new Error(item[0] + ' type does not exist')\n      }\n    }\n\n    if (!Array.isArray(items)) {\n      throw new Error('Events can only be sent as an array')\n    }\n\n    for (var i = 0, l = items.length; i < l; i++) {\n      parseItem(Array.prototype.slice.call(items[i]))\n    }\n  }\n\n  function die() {\n    LOCAL_STORAGE.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  this.addEventListener('beforeunload', die)\n  this.addEventListener('unload', die, false)\n\n  // Parse first what tbt.q contains\n  parseItems(this[DEFAULT_FUNCTION_NAME].q)\n\n  // Overwritte function\n  this[DEFAULT_FUNCTION_NAME] = function () {\n    parseItems([arguments])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n  \n  /**\n   * utility methods\n   */\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function setCookie(name, value) {\n    document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0\n      var v = c == 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + \"=\"\n    var ca = document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function rowsToCSV(rows) {\n    var escapeQuotes = function (str) {\n      return str.replace(/\\\"/g, '\"\"')\n    }\n\n    return rows.map(function (r) {\n      return r.map(function (field) {\n        if (typeof(field) === 'string') {\n          field = escapeQuotes(field)\n          if (field[0] !== '\"' || field[field.length - 1] !== '\"') {\n            field = '\"' + field  + '\"'\n          }\n          return field\n        }\n        return field\n      }).join(',')\n    }).join('\\n')\n  }\n})(window)\n\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["datasourceName","accountName","host","token","LOCAL_STORAGE","this","localStorage","HOST","userCookie","name","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","uploadEvents","n","url","formData","FormData","append","map","r","field","replace","join","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","setItem","delayUpload","onError","retries","setTimeout","parseItems","items","parseItem","item","Array","isArray","Error","args","prototype","slice","call","arguments","init","ev","location","href","navigator","userAgent","concat","fill","addEvent","die","stringify","d","Date","toISOString","Math","random","toString","addEventListener","q"],"mappings":"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"}