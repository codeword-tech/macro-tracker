{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || new URL(doc.currentScript.src).origin) +\n    '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n  var cookieDomain = getParameterByName('cookie-domain')\n\n  if (!dataSource)\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  if (!token) throw new Error(\"'token' is required to start sending events\")\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 5000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n\n      fetch(url, {\n        method: 'POST',\n        body: rowsToNDJSON(events)\n      })\n        .then(function (r) {\n          return r.json()\n        })\n        .then(function (res) {\n          if (res) {\n            events = []\n            storage.setItem(STORAGE_ITEM, '[]')\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function addEvent(eventName, eventProps) {\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = dateFormatted()\n    ev['session_start'] = session\n    ev['uuid'] = userCookie\n\n    events.push(ev)\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n\n  // Overwritte tinybird function\n  var queue = w.tinybird || []\n  w.tinybird = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n')\n  }\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie =\n      name +\n      '=' +\n      (value || '') +\n      '; path=/' +\n      '; domain=' +\n      (cookieDomain || window.location.hostname)\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    var ca = w.document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","URL","src","origin","dataSource","token","cookieDomain","Error","STORAGE_ITEM","TIMEOUT","userCookie","name","nameEQ","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","window","location","hostname","addEventListener","die","queue","tinybird","addEvent","apply","this","delayUpload","uploadEvents","n","onError","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","rowsToNDJSON","res","setItem","catch","retries","setTimeout","eventName","eventProps","ev","stringify","map","join","d","Date","toISOString","getAttribute"],"mappings":"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"}