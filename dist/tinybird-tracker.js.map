{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || new URL(doc.currentScript.src).origin) +\n    '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n\n  if (!dataSource)\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  if (!token) throw new Error(\"'token' is required to start sending events\")\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 5000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n\n      fetch(url, {\n        method: 'POST',\n        body: rowsToNDJSON(events)\n      })\n        .then(function (r) {\n          return r.json()\n        })\n        .then(function (res) {\n          if (res) {\n            events = []\n            storage.setItem(STORAGE_ITEM, '[]')\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function addEvent(eventName, eventProps) {\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = dateFormatted()\n    ev['session_start'] = session\n    ev['uuid'] = userCookie\n\n    events.push(ev)\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n\n  // Overwritte tinybird function\n  var queue = w.tinybird || []\n  w.tinybird = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n')\n  }\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie = name + '=' + (value || '') + '; path=/'\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    var ca = w.document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","URL","src","origin","dataSource","token","Error","STORAGE_ITEM","TIMEOUT","userCookie","name","nameEQ","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","addEventListener","die","queue","tinybird","addEvent","apply","this","delayUpload","uploadEvents","n","onError","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","rowsToNDJSON","res","setItem","catch","retries","setTimeout","eventName","eventProps","ev","stringify","map","join","d","Date","toISOString","getAttribute","window"],"mappings":"qCAEIA,EAAU,SAAUC,GACtB,IAAIC,EAAMD,EAAEE,SACRC,EAAUH,EAAEI,aAEhB,GAAKJ,GAAMA,EAAEE,UAAaF,EAAEE,SAASG,cAArC,CAIA,IAAIC,GACDC,EAAmB,QAAU,IAAIC,IAAIP,EAAII,cAAcI,KAAKC,QAC7D,aACEC,EAAaJ,EAAmB,UAChCK,EAAQL,EAAmB,SAE/B,IAAKI,EACH,UAAUE,MAAM,yDAClB,IAAKD,EAAO,UAAUC,MAAM,+CAE5B,IACIC,EAAe,kBAEfC,EAAU,IAEVC,EA+GJ,SAAmBC,GAGjB,IAFA,IAAIC,EAASD,YACTE,EAAKnB,EAAEE,SAASkB,OAAOC,MAAM,KACxBC,EAAI,EAAGA,EAAIH,EAAGI,SAAUD,EAAG,CAElC,IADA,IAAIE,EAAIL,EAAGG,GACY,MAAhBE,EAAEC,OAAO,IACdD,EAAIA,EAAEE,UAAU,EAAGF,EAAED,QAEvB,GAA0B,IAAtBC,EAAEG,QAAQT,GACZ,OAAOM,EAAEE,UAAUR,EAAOK,OAAQC,EAAED,QAGxC,YA3HeK,GACbC,EAASC,KAAKC,MAAM5B,EAAQ6B,QAAQlB,IAAiB,MACrDmB,EAAUC,IACVC,GAAY,EAEXnB,IACHA,EA8FO,uCAAuCoB,QAAQ,QAAS,SAAUZ,GACvE,IAAIa,EAAqB,GAAhBC,KAAKC,SAAiB,EAE/B,OADa,KAALf,EAAWa,EAAS,EAAJA,EAAW,GAC1BG,SAAS,MAKpBxC,EAAEE,SAASkB,OAASH,aArGGD,GAqGoB,IAAM,YApCnDhB,EAAEyC,iBAAiB,eAAgBC,GACnC1C,EAAEyC,iBAAiB,SAAUC,GAAK,GAGlC,IAAIC,EAAQ3C,EAAE4C,UAAY,GAC1B5C,EAAE4C,SAAWC,EACb,IAAK,IAAIvB,EAAI,EAAGA,EAAIqB,EAAMpB,OAAQD,IAChCuB,EAASC,MAAMC,KAAMJ,EAAMrB,IAI7B0B,EAAYjC,EAtFM,GAalB,SAASkC,EAAaC,GAGpB,SAASC,IACHD,EAAI,IAENf,GAAY,EACZa,EAAYjC,EAASmC,EAAI,IANzBf,IAUAN,EAAON,OAAS,GAClBY,GAAY,EC/CH,SAASiB,EAAEF,GAAG,OAAOA,EAAEA,GAAG,GAAG,IAAIG,QAAQ,SAASC,EAAEjB,GAAG,IAAIkB,EAAE,IAAIC,eAAeC,EAAE,GAAGC,EAAE,GAAGpC,EAAE,GAAGqC,EAAE,WAAW,MAAM,CAACC,GAAG,IAAIL,EAAEM,OAAO,IAAI,GAAGC,WAAWP,EAAEO,WAAWD,OAAON,EAAEM,OAAOE,IAAIR,EAAES,YAAYC,KAAK,WAAW,OAAOZ,QAAQa,QAAQX,EAAEY,eAAeC,KAAK,WAAW,OAAOf,QAAQa,QAAQX,EAAEY,cAAcE,KAAKvC,KAAKC,QAAQuC,KAAK,WAAW,OAAOjB,QAAQa,QAAQ,IAAIK,KAAK,CAAChB,EAAEiB,aAAaC,MAAMd,EAAEe,QAAQ,CAACC,KAAK,WAAW,OAAOlB,GAAGmB,QAAQ,WAAW,OAAOlB,GAAGmB,IAAI,SAASzB,GAAG,OAAO9B,EAAE8B,EAAE0B,gBAAgBC,IAAI,SAAS3B,GAAG,OAAOA,EAAE0B,gBAAgBxD,MAAM,IAAI,IAAI0D,KAAKzB,EAAE0B,KAAK/B,EAAEgC,QAAQ,MAAM9B,GAAE,GAAIG,EAAE4B,OAAO,WAAW5B,EAAE6B,wBAAwBhD,QAAQ,+BAA+B,SAASgB,EAAEF,EAAEI,GAAGG,EAAE4B,KAAKnC,EAAEA,EAAE4B,eAAepB,EAAE2B,KAAK,CAACnC,EAAEI,IAAIhC,EAAE4B,GAAG5B,EAAE4B,GAAG5B,EAAE4B,GAAG,IAAII,EAAEA,IAAIA,EAAEK,MAAMJ,EAAE+B,QAAQjD,EAAEkB,EAAEgC,gBAAgB,WAAWrC,EAAEsC,YAAYtC,EAAEwB,QAAQnB,EAAEkC,iBAAiBT,EAAE9B,EAAEwB,QAAQM,IAAIzB,EAAEmC,KAAKxC,EAAEyC,MAAM,QDmD33BC,CAFUtF,EAAS,SAAWK,EAAa,UAAYC,EAE5C,CACTsE,OAAQ,OACRS,KAAME,EAAahE,KAElBwC,KAAK,SAAUhC,GACd,OAAOA,EAAE+B,SAEVC,KAAK,SAAUyB,GACVA,GACFjE,EAAS,GACT1B,EAAQ4F,QAAQjF,EAAc,MAC9BkC,EAAYjC,EAxCJ,IA0CRoC,IAEFhB,GAAY,IAEb6D,MAAM,SAAU5C,GACfD,OAGJH,EAAYjC,EAlDE,IAsDlB,SAASiC,EAAYM,EAAG2C,GACtBC,WAAW,WACTjD,EAAagD,IACZ3C,GAGL,SAAST,EAASsD,EAAWC,GAC3B,IAAIC,EAAKD,GAAc,GACvBC,EAAE,MAAYF,GAAa,GAC3BE,EAAE,UAAgBnE,IAClBmE,EAAE,cAAoBpE,EACtBoE,EAAE,KAAWrF,EAEba,EAAOwD,KAAKgB,GAGd,SAAS3D,IACPvC,EAAQ4F,QAAQjF,EAAcgB,KAAKwE,UAAUzE,IAC7CoB,IAoBF,SAAS4C,EAAahE,GAEpB,OADqBA,EAAO0E,IAAInD,GAAKtB,KAAKwE,UAAUlD,IAChCoD,KAAK,MAG3B,SAAStE,EAAcuE,GAErB,OADAA,EAAIA,GAAK,IAAIC,MACJC,cAAcvE,QAAQ,IAAK,KAAKf,MAAM,KAAK,GA8BtD,SAASd,EAAmBU,GAC1B,OAAOhB,EAAII,cAAcuG,aAAa,QAAU3F,YAIpDlB,EAAQ8G"}