{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || 'https://api.tinybird.co') + '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n  var cookieEnabled = getParameterByName('cookie-enabled') === 'false' ? false : true\n  var cookieDomain = getParameterByName('cookie-domain') || w.location.hostname\n  var functionName = getParameterByName('function') || 'tinybird'\n\n  if (!dataSource) {\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  }\n  if (!token) {\n    throw new Error(\"'token' is required to start sending events\")\n  }\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var STORAGE_LAST_TIMESTAMP = 'tinybird_last_activity'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 1000\n  var REFRESH_SESSION = 30 * 60 * 1000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var uuid = uuidv4()\n  var sessionStart = getUTCNow()\n  var uploading = false\n\n  if (cookieEnabled) {\n    if (!userCookie) {\n      setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n    } else {\n      var cookieValue = parseCookieValue(getCookie(COOKIE_NAME))\n      if (cookieValue) {\n        uuid = cookieValue.id\n        sessionStart = cookieValue.sessionStart\n      } else {\n        // Old cookie format - Let's reset it with a new value\n        setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n      }\n    }\n  } else {\n    if (userCookie) {\n      deleteCookie(COOKIE_NAME)\n    }\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n\n      fetch(url, {\n        method: 'POST',\n        body: rowsToNDJSON(events)\n      })\n        .then(function (r) {\n          var status = r ? r.status : 0\n          if (status === 200 || status === 202) {\n            clearEvents()\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function saveLastActivityTimestamp() {\n    storage.setItem(STORAGE_LAST_TIMESTAMP, JSON.stringify(getUTCNow()))\n  }\n\n  function addEvent(eventName, eventProps) {\n    var timestamp = getUTCNow()\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = utcToFormattedDate(timestamp)\n    ev['session_start'] = utcToFormattedDate(sessionStart)\n    ev['uuid'] = cookieEnabled ? uuid : ''\n    \n    events.push(ev)\n\n    saveLastActivityTimestamp()\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  function refreshSessionStart() {\n    var now = getUTCNow()\n    var lastActivityTimestamp = storage.getItem(STORAGE_LAST_TIMESTAMP)\n    if (lastActivityTimestamp !== null) {\n      var elapsed = now - parseInt(lastActivityTimestamp, 10)\n      if (elapsed > REFRESH_SESSION) {\n        sessionStart = now\n        cookieEnabled && setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n        saveLastActivityTimestamp()\n      }\n    }\n  }\n\n  var hidden, visibilityChange\n  if (typeof doc.hidden !== 'undefined') {\n    // Opera 12.10 and Firefox 18 and later support\n    hidden = 'hidden'\n    visibilityChange = 'visibilitychange'\n  } else if (typeof doc.msHidden !== 'undefined') {\n    hidden = 'msHidden'\n    visibilityChange = 'msvisibilitychange'\n  } else if (typeof doc.webkitHidden !== 'undefined') {\n    hidden = 'webkitHidden'\n    visibilityChange = 'webkitvisibilitychange'\n  }\n\n  function handleVisibilityChange() {\n    if (!doc[hidden]) {\n      refreshSessionStart()\n    }\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n  doc.addEventListener(visibilityChange, handleVisibilityChange, false)\n\n  refreshSessionStart()\n\n  // Overwritte main function\n  var queue = w[functionName] || []\n  w[functionName] = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n')\n  }\n\n  function utcToFormattedDate(utcDate) {\n    var date = new Date(utcDate)\n    return date.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function getUTCNow() {\n    var date = new Date()\n    var utcNow = Date.UTC(\n      date.getUTCFullYear(),\n      date.getUTCMonth(),\n      date.getUTCDate(),\n      date.getUTCHours(),\n      date.getUTCMinutes(),\n      date.getUTCSeconds(),\n      date.getUTCMilliseconds()\n    )\n\n    return utcNow\n  }\n\n  function formatCookieValue(id, sessionStart) {\n    return id + ':' + sessionStart\n  }\n\n  function parseCookieValue(cookieValue) {\n    if (cookieValue) {\n      var slices = cookieValue.split(':')\n      if (slices.length === 2) {\n        return {\n          id: slices[0],\n          sessionStart: parseInt(slices[1], 10)\n        }\n      }\n    }\n    return null\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie =\n      name + '=' + (value || '') + '; path=/; domain=' + cookieDomain\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    if (w.document.cookie) {\n      var ca = w.document.cookie.split(';')\n      for (var i = 0; i < ca.length; ++i) {\n        var c = ca[i]\n        while (c.charAt(0) === ' ') {\n          c = c.substring(1, c.length)\n        }\n        if (c.indexOf(nameEQ) === 0) {\n          return c.substring(nameEQ.length, c.length)\n        }\n      }\n    }\n    return null\n  }\n\n  function deleteCookie(name) {\n    w.document.cookie = name +'=; path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; domain=' + cookieDomain\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n\n  function clearEvents() {\n    events = []\n    storage.setItem(STORAGE_ITEM, JSON.stringify([]))\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","dataSource","token","cookieEnabled","cookieDomain","location","hostname","functionName","Error","hidden","visibilityChange","COOKIE_NAME","STORAGE_ITEM","STORAGE_LAST_TIMESTAMP","TIMEOUT","userCookie","getCookie","events","JSON","parse","getItem","uuid","replace","c","r","Math","random","toString","sessionStart","getUTCNow","uploading","cookieValue","slices","split","length","id","parseInt","parseCookieValue","setCookie","formatCookieValue","cookie","msHidden","webkitHidden","addEventListener","die","refreshSessionStart","queue","addEvent","i","apply","this","delayUpload","uploadEvents","n","onError","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","rowsToNDJSON","setItem","stringify","catch","retries","setTimeout","saveLastActivityTimestamp","eventName","eventProps","timestamp","ev","utcToFormattedDate","now","lastActivityTimestamp","map","join","utcDate","Date","toISOString","date","UTC","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","getUTCMilliseconds","name","value","nameEQ","ca","charAt","substring","indexOf","getAttribute","window"],"mappings":"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"}