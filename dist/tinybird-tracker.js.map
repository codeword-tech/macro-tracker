{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || new URL(doc.currentScript.src).origin) +\n    '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n\n  if (!dataSource)\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  if (!token) throw new Error(\"'token' is required to start sending events\")\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 5000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n      var formData = new FormData()\n      formData.append('ndjson', rowsToNDJSON(events))\n\n      fetch(url, {\n        method: 'POST',\n        body: formData\n      })\n        .then(function (r) {\n          return r.json()\n        })\n        .then(function (res) {\n          if (res) {\n            events = []\n            storage.setItem(STORAGE_ITEM, '[]')\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function addEvent(eventName, eventProps) {\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = dateFormatted()\n    ev['session_start'] = session\n    ev['uuid'] = userCookie\n\n    events.push(ev)\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n\n  // Overwritte tinybird function\n  var queue = w.tinybird || []\n  w.tinybird = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n') + '\\n'\n  }\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie = name + '=' + (value || '') + '; path=/'\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    var ca = w.document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","URL","src","origin","dataSource","token","Error","STORAGE_ITEM","TIMEOUT","userCookie","name","nameEQ","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","addEventListener","die","queue","tinybird","addEvent","apply","this","delayUpload","uploadEvents","n","url","formData","FormData","append","map","e","stringify","join","rowsToNDJSON","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","res","setItem","onError","catch","retries","setTimeout","eventName","eventProps","ev","d","Date","toISOString","getAttribute","window"],"mappings":"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"}