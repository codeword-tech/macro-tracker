{"version":3,"file":"tinybird-tracker.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\r\n\r\nvar TRACKER_COLUMNS = 14\r\nvar COOKIE_NAME = '_track'\r\nvar LOCAL_STORAGE = window.localStorage\r\nvar STORAGE_ITEM = 'tinybird_events'\r\nvar DATASOURCE_NAME = 'tracker'\r\nvar MAX_RETRIES = 5\r\nvar TIMEOUT = 2000\r\n\r\n/**\r\n * install a tracker for the user\r\n */\r\nfunction tracker(token, accountName, globalFunctionName, host) {\r\n  globalFunctionName = globalFunctionName || 'tracker_ga'\r\n  var userCookie = getCookie(COOKIE_NAME)\r\n  var events = JSON.parse(LOCAL_STORAGE.getItem(STORAGE_ITEM) || '[]')\r\n  var session = dateFormatted()\r\n  var uploading = false\r\n\r\n  if (!userCookie) {\r\n    userCookie = uuidv4()\r\n    setCookie(COOKIE_NAME, userCookie)\r\n  }\r\n\r\n  function uploadEvents(n) {\r\n    if (uploading) return\r\n\r\n    function onError () {\r\n      if (n > 0) {\r\n        // set uploading to false to allow recheck\r\n        uploading = false\r\n        delayUpload(TIMEOUT, n - 1)\r\n      }\r\n    }\r\n\r\n    if (events.length > 0) {\r\n      uploading = true\r\n      \r\n      var url = (host ||Â 'https://api.tinybird.co') +\r\n        '/v0/datasources?mode=append&name=' + DATASOURCE_NAME +\r\n        '&token=' + token\r\n      var formData = new FormData()\r\n      formData.append('csv', rowsToCSV(events))\r\n\r\n      fetch(url, {\r\n        method: 'POST',\r\n        body: formData\r\n      })\r\n      .then(function (r) {\r\n        return r.json()\r\n      })\r\n      .then(function (res) {\r\n        if (res) {\r\n          events = []\r\n          LOCAL_STORAGE.setItem(STORAGE_ITEM, '[]')\r\n          delayUpload(TIMEOUT, MAX_RETRIES)\r\n        } else {\r\n          onError()\r\n        }\r\n        uploading = false\r\n      })\r\n      .catch(function () {\r\n        onError()\r\n      })\r\n    } else {\r\n      delayUpload(TIMEOUT, MAX_RETRIES)\r\n    }\r\n  }\r\n\r\n  function delayUpload(t, retries) {\r\n    setTimeout(function () {\r\n      uploadEvents(retries)\r\n    }, t)\r\n  }\r\n\r\n  delayUpload(TIMEOUT, MAX_RETRIES)\r\n\r\n  tracker.flush = uploadEvents\r\n\r\n  window[globalFunctionName] = function () {\r\n    var ev = [\r\n      dateFormatted(),\r\n      session,\r\n      accountName,\r\n      userCookie,\r\n      document.location.href,\r\n      encodeURIComponent(navigator.userAgent)\r\n    ].concat(Array.prototype.slice.call(arguments))\r\n    if (ev.length < TRACKER_COLUMNS) {\r\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\r\n    }\r\n    events.push(ev)\r\n\r\n    // If the event is pageload, don't wait to the flush\r\n    if(arguments[0] === 'pageload') {\r\n      uploadEvents()\r\n    }\r\n  }\r\n\r\n  function die() {\r\n    LOCAL_STORAGE.setItem(STORAGE_ITEM, JSON.stringify(events))\r\n    uploadEvents()\r\n  }\r\n\r\n  window.addEventListener('beforeunload', die)\r\n  window.addEventListener('unload', die, false)\r\n}\r\n\r\nwindow['tracker'] = tracker\r\n\r\n/**\r\n * utility methods\r\n */\r\n\r\nfunction dateFormatted(d) {\r\n  d = d || new Date()\r\n  return d.toISOString().replace('T', ' ').split('.')[0]\r\n}\r\n\r\nfunction setCookie(name, value) {\r\n  document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\r\n}\r\n\r\nfunction uuidv4() {\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n    var r = Math.random() * 16 | 0\r\n    var v = c == 'x' ? r : (r & 0x3 | 0x8)\r\n    return v.toString(16)\r\n  })\r\n}\r\n\r\nfunction getCookie(name) {\r\n  var nameEQ = name + \"=\"\r\n  var ca = document.cookie.split(';')\r\n  for (var i = 0; i < ca.length; ++i) {\r\n    var c = ca[i]\r\n    while (c.charAt(0) === ' ') {\r\n      c = c.substring(1, c.length)\r\n    }\r\n    if (c.indexOf(nameEQ) === 0) {\r\n      return c.substring(nameEQ.length, c.length)\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nfunction rowsToCSV(rows) {\r\n  var escapeQuotes = function (str) {\r\n    return str.replace(/\\\"/g, '\"\"')\r\n  }\r\n\r\n  return rows.map(function (r) {\r\n    return r.map(function (field) {\r\n      if (typeof(field) === 'string') {\r\n        field = escapeQuotes(field)\r\n        if (field[0] !== '\"' || field[field.length - 1] !== '\"') {\r\n          field = '\"' + field  + '\"'\r\n        }\r\n        return field\r\n      }\r\n      return field\r\n    }).join(',')\r\n  }).join('\\n')\r\n}\r\n\r\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["LOCAL_STORAGE","window","localStorage","tracker","token","accountName","globalFunctionName","host","userCookie","name","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","uploadEvents","n","url","formData","FormData","append","map","r","field","replace","join","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","setItem","delayUpload","onError","retries","setTimeout","die","stringify","Math","random","toString","flush","ev","location","href","encodeURIComponent","navigator","userAgent","concat","Array","prototype","slice","call","arguments","fill","addEventListener","d","Date","toISOString"],"mappings":"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"}