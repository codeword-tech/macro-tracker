{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = function (w) {\n  var doc = w.document\n  var storage = w.localStorage\n\n  if (!w || !w.document || !w.document.currentScript) {\n    return\n  }\n\n  var apiUrl =\n    (getParameterByName('api') || 'https://api.tinybird.co') + '/v0/events'\n  var dataSource = getParameterByName('source')\n  var token = getParameterByName('token')\n  var cookieDomain = getParameterByName('cookie-domain') || w.location.hostname\n  var functionName = getParameterByName('function') || 'tinybird'\n\n  if (!dataSource) {\n    throw new Error(\"'dataSource' name is required to start sending events\")\n  }\n  if (!token) {\n    throw new Error(\"'token' is required to start sending events\")\n  }\n\n  var COOKIE_NAME = 'tinybird'\n  var STORAGE_ITEM = 'tinybird_events'\n  var STORAGE_LAST_TIMESTAMP = 'tinybird_last_activity'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 1000\n  var REFRESH_SESSION = 30 * 60 * 1000\n\n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || '[]')\n  var uuid = uuidv4()\n  var sessionStart = getUTCNow()\n  var uploading = false\n\n  if (!userCookie) {\n    setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n  } else {\n    var cookieValue = parseCookieValue(getCookie(COOKIE_NAME))\n    if (cookieValue) {\n      uuid = cookieValue.id\n      sessionStart = cookieValue.sessionStart\n    } else {\n      // Old cookie format - Let's reset it with a new value\n      setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n    }\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n\n      var url = apiUrl + '?name=' + dataSource + '&token=' + token\n\n      fetch(url, {\n        method: 'POST',\n        body: rowsToNDJSON(events)\n      })\n        .then(function (r) {\n          var status = r ? r.status : 0\n          if (status === 200 || status === 202) {\n            clearEvents()\n            delayUpload(TIMEOUT, MAX_RETRIES)\n          } else {\n            onError()\n          }\n          uploading = false\n        })\n        .catch(function (e) {\n          onError()\n        })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function saveLastActivityTimestamp() {\n    storage.setItem(STORAGE_LAST_TIMESTAMP, JSON.stringify(getUTCNow()))\n  }\n\n  function addEvent(eventName, eventProps, anonymize) {\n    var timestamp = getUTCNow()\n    var ev = eventProps || {}\n    ev['event'] = eventName || ''\n    ev['timestamp'] = utcToFormattedDate(timestamp)\n    ev['session_start'] = utcToFormattedDate(sessionStart)\n    ev['uuid'] = !anonymize || (anonymize && anonymize !== true) ? uuid : ''\n    \n    events.push(ev)\n\n    saveLastActivityTimestamp()\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  function refreshSessionStart() {\n    var now = getUTCNow()\n    var lastActivityTimestamp = storage.getItem(STORAGE_LAST_TIMESTAMP)\n    if (lastActivityTimestamp !== null) {\n      var elapsed = now - parseInt(lastActivityTimestamp, 10)\n      if (elapsed > REFRESH_SESSION) {\n        sessionStart = now\n        setCookie(COOKIE_NAME, formatCookieValue(uuid, sessionStart))\n        saveLastActivityTimestamp()\n      }\n    }\n  }\n\n  var hidden, visibilityChange\n  if (typeof doc.hidden !== 'undefined') {\n    // Opera 12.10 and Firefox 18 and later support\n    hidden = 'hidden'\n    visibilityChange = 'visibilitychange'\n  } else if (typeof doc.msHidden !== 'undefined') {\n    hidden = 'msHidden'\n    visibilityChange = 'msvisibilitychange'\n  } else if (typeof doc.webkitHidden !== 'undefined') {\n    hidden = 'webkitHidden'\n    visibilityChange = 'webkitvisibilitychange'\n  }\n\n  function handleVisibilityChange() {\n    if (!doc[hidden]) {\n      refreshSessionStart()\n    }\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n  doc.addEventListener(visibilityChange, handleVisibilityChange, false)\n\n  refreshSessionStart()\n\n  // Overwritte main function\n  var queue = w[functionName] || []\n  w[functionName] = addEvent\n  for (var i = 0; i < queue.length; i++) {\n    addEvent.apply(this, queue[i])\n  }\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map(e => JSON.stringify(e))\n    return stringEvents.join('\\n')\n  }\n\n  function utcToFormattedDate(utcDate) {\n    var date = new Date(utcDate)\n    return date.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function getUTCNow() {\n    var date = new Date()\n    var utcNow = Date.UTC(\n      date.getUTCFullYear(),\n      date.getUTCMonth(),\n      date.getUTCDate(),\n      date.getUTCHours(),\n      date.getUTCMinutes(),\n      date.getUTCSeconds(),\n      date.getUTCMilliseconds()\n    )\n\n    return utcNow\n  }\n\n  function formatCookieValue(id, sessionStart) {\n    return id + ':' + sessionStart\n  }\n\n  function parseCookieValue(cookieValue) {\n    if (cookieValue) {\n      var slices = cookieValue.split(':')\n      if (slices.length === 2) {\n        return {\n          id: slices[0],\n          sessionStart: parseInt(slices[1], 10)\n        }\n      }\n    }\n    return null\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = (Math.random() * 16) | 0\n      var v = c == 'x' ? r : (r & 0x3) | 0x8\n      return v.toString(16)\n    })\n  }\n\n  function setCookie(name, value) {\n    w.document.cookie =\n      name + '=' + (value || '') + '; path=/' + '; domain=' + cookieDomain\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + '='\n    if (w.document.cookie) {\n      var ca = w.document.cookie.split(';')\n      for (var i = 0; i < ca.length; ++i) {\n        var c = ca[i]\n        while (c.charAt(0) === ' ') {\n          c = c.substring(1, c.length)\n        }\n        if (c.indexOf(nameEQ) === 0) {\n          return c.substring(nameEQ.length, c.length)\n        }\n      }\n    }\n    return null\n  }\n\n  function getParameterByName(name) {\n    return doc.currentScript.getAttribute('data-' + name)\n  }\n\n  function clearEvents() {\n    events = []\n    storage.setItem(STORAGE_ITEM, JSON.stringify([]))\n  }\n}\n\ntracker(window)\n\nexport default tracker\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","doc","document","storage","localStorage","currentScript","apiUrl","getParameterByName","dataSource","token","cookieDomain","location","hostname","functionName","Error","hidden","visibilityChange","COOKIE_NAME","STORAGE_ITEM","STORAGE_LAST_TIMESTAMP","TIMEOUT","userCookie","getCookie","events","JSON","parse","getItem","uuid","replace","c","r","Math","random","toString","sessionStart","getUTCNow","uploading","cookieValue","slices","split","length","id","parseInt","parseCookieValue","setCookie","formatCookieValue","msHidden","webkitHidden","addEventListener","die","refreshSessionStart","queue","addEvent","i","apply","this","delayUpload","uploadEvents","n","onError","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","rowsToNDJSON","setItem","stringify","catch","retries","setTimeout","saveLastActivityTimestamp","eventName","eventProps","anonymize","timestamp","ev","utcToFormattedDate","now","lastActivityTimestamp","map","join","utcDate","Date","toISOString","date","UTC","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","getUTCMilliseconds","name","value","cookie","nameEQ","ca","charAt","substring","indexOf","getAttribute","window"],"mappings":"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"}