{"version":3,"file":"tinybird-tracker.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\r\n\r\nconst TRACKER_COLUMNS = 14\r\nconst cookieName = '_track'\r\nconst localStorage = window.localStorage\r\nconst storageItem = 'tinybird_events'\r\nconst datasourceName = 'tracker'\r\nconst MAX_RETRIES = 5\r\nconst TIMEOUT = 2000\r\n\r\n/**\r\n * install a tracker for the user\r\n */\r\nfunction tracker(token, accountName, globalFunctionName, host) {\r\n  globalFunctionName = globalFunctionName || 'tracker_ga'\r\n  let userCookie = getCookie(cookieName)\r\n\r\n  if (!userCookie) {\r\n    userCookie = uuidv4()\r\n    setCookie(cookieName, userCookie)\r\n  }\r\n\r\n  const session = dateFormatted()\r\n  let events = JSON.parse(localStorage.getItem(storageItem) || '[]')\r\n\r\n  var uploading = false\r\n  function uploadEvents(n) {\r\n    if (uploading) return\r\n\r\n    if (events.length > 0) {\r\n      uploading = true\r\n      const formData = new FormData()\r\n      formData.append('csv', events)\r\n\r\n      fetch(`${host ||Â 'https://api.tinybird.co'}/v0/datasources?mode=append&name=${datasourceName}&token=${token}`, {\r\n        method: 'POST',\r\n        body: formData\r\n      })\r\n      .then(r => r.json())\r\n      .then(res => {\r\n        if (res && !res.error) {\r\n          events = []\r\n          window.localStorage.setItem(storageItem, '[]')\r\n          delayUpload(TIMEOUT, MAX_RETRIES)\r\n        } else {\r\n          if (n > 0) {\r\n            // set uploading to false to allow recheck\r\n            uploading = false\r\n            delayUpload(TIMEOUT, n - 1)\r\n          }\r\n        }\r\n        uploading = false\r\n      })\r\n      .catch(err => {\r\n        if (n > 0) {\r\n          // set uploading to false to allow recheck\r\n          uploading = false\r\n          delayUpload(TIMEOUT, n - 1)\r\n        }\r\n      })\r\n    } else {\r\n      delayUpload(TIMEOUT, MAX_RETRIES)\r\n    }\r\n  }\r\n\r\n  function delayUpload(t, retries) {\r\n    setTimeout(function () {\r\n      uploadEvents(retries)\r\n    }, t)\r\n  }\r\n\r\n  delayUpload(TIMEOUT, MAX_RETRIES)\r\n\r\n  tracker.flush = uploadEvents\r\n\r\n  window[globalFunctionName] = function () {\r\n    let ev = [dateFormatted(), session, accountName, userCookie, document.location.href, navigator.userAgent].concat(Array.prototype.slice.call(arguments))\r\n    if (ev.length < TRACKER_COLUMNS) {\r\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\r\n    }\r\n    events.push(ev)\r\n\r\n    // when the event is pageload send it right awat, do not wait to the flush\r\n    if(arguments[0] === 'pageload') {\r\n      uploadEvents();\r\n    }\r\n  }\r\n\r\n  function die() {\r\n    localStorage.setItem(storageItem, JSON.stringify(events))\r\n    uploadEvents()\r\n  }\r\n\r\n  window.addEventListener('beforeunload', die)\r\n  window.addEventListener('unload', die, false)\r\n}\r\n\r\nwindow['tracker'] = tracker\r\n\r\n/**\r\n * utility methods\r\n */\r\n\r\nfunction dateFormatted(d) {\r\n  d = d || new Date()\r\n  return d.toISOString().replace('T', ' ').split('.')[0]\r\n}\r\n\r\nfunction setCookie(name, value) {\r\n  document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\r\n}\r\n\r\nfunction uuidv4() {\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n    const r = Math.random() * 16 | 0\r\n    const v = c == 'x' ? r : (r & 0x3 | 0x8)\r\n    return v.toString(16)\r\n  })\r\n}\r\n\r\nfunction getCookie(name) {\r\n  const nameEQ = name + \"=\"\r\n  const ca = document.cookie.split(';')\r\n  for (let i = 0; i < ca.length; ++i) {\r\n    let c = ca[i]\r\n    while (c.charAt(0) === ' ') {\r\n      c = c.substring(1, c.length)\r\n    }\r\n    if (c.indexOf(nameEQ) === 0) {\r\n      return c.substring(nameEQ.length, c.length)\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["localStorage","window","tracker","token","accountName","globalFunctionName","host","userCookie","name","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","replace","r","Math","random","toString","session","dateFormatted","events","JSON","parse","getItem","uploading","uploadEvents","n","formData","FormData","append","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","error","setItem","delayUpload","err","retries","setTimeout","die","stringify","flush","ev","location","href","navigator","userAgent","concat","Array","prototype","slice","call","arguments","fill","addEventListener","d","Date","toISOString"],"mappings":"iCAEA,IAEMA,EAAeC,OAAOD,aAS5B,SAASE,EAAQC,EAAOC,EAAaC,EAAoBC,GACvDD,EAAqBA,GAAsB,aAC3C,IAAIE,EAyGN,SAAmBC,GAGjB,IAFA,IACMC,EAAKC,SAASC,OAAOC,MAAM,KACxBC,EAAI,EAAGA,EAAIJ,EAAGK,SAAUD,EAAG,CAElC,IADA,IAAIE,EAAIN,EAAGI,GACY,MAAhBE,EAAEC,OAAO,IACdD,EAAIA,EAAEE,UAAU,EAAGF,EAAED,QAEvB,GAA0B,IAAtBC,EAAEG,QAPOV,WAQX,OAAOO,EAAEE,UARET,UAQeM,OAAQC,EAAED,QAGxC,YArHiBK,GAEZZ,IACHA,EA+FK,uCAAuCa,QAAQ,QAAS,SAAUL,GACvE,IAAMM,EAAoB,GAAhBC,KAAKC,SAAgB,EAE/B,OADe,KAALR,EAAWM,EAAS,EAAJA,EAAU,GAC3BG,SAAS,MAPpBd,SAASC,OAASH,WA1FMD,GA0FiB,IAAM,YAvF/C,IAAMkB,EAAUC,IACZC,EAASC,KAAKC,MAAM7B,EAAa8B,QAlBnB,oBAkB2C,MAEzDC,GAAY,EAChB,SAASC,EAAaC,GACpB,IAAIF,EAEJ,GAAIJ,EAAOb,OAAS,EAAG,CACrBiB,GAAY,EACZ,IAAMG,EAAW,IAAIC,SACrBD,EAASE,OAAO,MAAOT,GChCd,SAASU,EAAEJ,GAAG,OAAOA,EAAEA,GAAG,GAAG,IAAIK,QAAQ,SAASC,EAAElB,GAAG,IAAImB,EAAE,IAAIC,eAAeC,EAAE,GAAGC,EAAE,GAAG9B,EAAE,GAAG+B,EAAE,WAAW,MAAM,CAACC,GAAG,IAAIL,EAAEM,OAAO,IAAI,GAAGC,WAAWP,EAAEO,WAAWD,OAAON,EAAEM,OAAOE,IAAIR,EAAES,YAAYC,KAAK,WAAW,OAAOZ,QAAQa,QAAQX,EAAEY,eAAeC,KAAK,WAAW,OAAOf,QAAQa,QAAQvB,KAAKC,MAAMW,EAAEY,gBAAgBE,KAAK,WAAW,OAAOhB,QAAQa,QAAQ,IAAII,KAAK,CAACf,EAAEgB,aAAaC,MAAMb,EAAEc,QAAQ,CAACC,KAAK,WAAW,OAAOjB,GAAGkB,QAAQ,WAAW,OAAOjB,GAAGkB,IAAI,SAASxB,GAAG,OAAOxB,EAAEwB,EAAEyB,gBAAgBC,IAAI,SAAS1B,GAAG,OAAOA,EAAEyB,gBAAgBjD,MAAM,IAAI,IAAImD,KAAKxB,EAAEyB,KAAKhC,EAAEiC,QAAQ,MAAM7B,GAAE,GAAIG,EAAE2B,OAAO,WAAW3B,EAAE4B,wBAAwBhD,QAAQ,+BAA+B,SAASiB,EAAEJ,EAAEM,GAAGG,EAAE2B,KAAKpC,EAAEA,EAAE6B,eAAenB,EAAE0B,KAAK,CAACpC,EAAEM,IAAI1B,EAAEoB,GAAGpB,EAAEoB,GAAGpB,EAAEoB,GAAG,IAAIM,EAAEA,IAAIA,EAAEK,MAAMJ,EAAE8B,QAAQjD,EAAEmB,EAAE+B,gBAAgB,WAAWtC,EAAEuC,YAAYvC,EAAEyB,QAAQlB,EAAEiC,iBAAiBT,EAAE/B,EAAEyB,QAAQM,IAAIxB,EAAEkC,KAAKzC,EAAE0C,MAAM,QDkCt3BC,EAAStE,GAAQ,6EAAqFH,EAAS,CAC7G+D,OAAQ,OACRS,KAAMzC,IAEP2C,KAAK,SAAAxD,UAAKA,EAAEgC,SACZwB,KAAK,SAAAC,GACAA,IAAQA,EAAIC,OACdpD,EAAS,GACT1B,OAAOD,aAAagF,QArCV,kBAqC+B,MACzCC,EAnCM,IADI,IAsCNhD,EAAI,IAENF,GAAY,EACZkD,EAxCI,IAwCiBhD,EAAI,IAG7BF,GAAY,UAEP,SAAAmD,GACDjD,EAAI,IAENF,GAAY,EACZkD,EAjDM,IAiDehD,EAAI,WAI7BgD,EArDU,IADI,GA0DlB,SAASA,EAAY1C,EAAG4C,GACtBC,WAAW,WACTpD,EAAamD,IACZ5C,GAoBL,SAAS8C,IACPrF,EAAagF,QApFG,kBAoFkBpD,KAAK0D,UAAU3D,IACjDK,IAnBFiD,EA/Dc,IADI,GAkElB/E,EAAQqF,MAAQvD,EAEhB/B,OAAOI,GAAsB,WAC3B,IAAImF,EAAK,CAAC9D,IAAiBD,EAASrB,EAAaG,EAAYG,SAAS+E,SAASC,KAAMC,UAAUC,WAAWC,OAAOC,MAAMC,UAAUC,MAAMC,KAAKC,YACxIV,EAAG1E,OA3Ea,KA4ElB0E,EAAKA,EAAGK,OAAOC,MA5EG,GA4EqBN,EAAG1E,QAAQqF,KAAK,MAEzDxE,EAAO0C,KAAKmB,GAGQ,aAAjBU,UAAU,IACXlE,KASJ/B,OAAOmG,iBAAiB,eAAgBf,GACxCpF,OAAOmG,iBAAiB,SAAUf,GAAK,GASzC,SAAS3D,EAAc2E,GAErB,OADAA,EAAIA,GAAK,IAAIC,MACJC,cAAcnF,QAAQ,IAAK,KAAKR,MAAM,KAAK,UARtDX,OAAM,QAAcC"}