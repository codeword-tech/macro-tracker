{"version":3,"file":"tinybird-tracker.js","sources":["../src/index.js","../node_modules/unfetch/dist/unfetch.module.js"],"sourcesContent":["import fetch from \"unfetch\";\n\nvar tracker = function (w) {\n  var doc = w.document;\n  var storage = w.localStorage;\n  var currentScript = doc.currentScript;\n\n  if (!w || !currentScript) {\n    return;\n  }\n\n  var api =\n    (getParameterByName(\"api\") || new URL(currentScript.src).origin) +\n    \"/v0/datasources\";\n  var dataSource = getParameterByName(\"source\");\n  var token = getParameterByName(\"token\");\n\n  if (!dataSource)\n    throw new Error(\"'dataSource' name is required to start sending events\");\n  if (!token) throw new Error(\"'token' is required to start sending events\");\n\n  var COOKIE_NAME = \"tinybird\";\n  var STORAGE_ITEM = \"tinybird_events\";\n  var MAX_RETRIES = 5;\n  var TIMEOUT = 2000;\n\n  var userCookie = getCookie(COOKIE_NAME);\n  var events = JSON.parse(storage.getItem(STORAGE_ITEM) || \"[]\");\n  var session = dateFormatted();\n  var uploading = false;\n\n  if (!userCookie) {\n    userCookie = uuidv4();\n    setCookie(COOKIE_NAME, userCookie);\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return;\n\n    function onError() {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false;\n        delayUpload(TIMEOUT, n - 1);\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true;\n\n      var url =\n        api +\n        \"?format=ndjson&mode=append&name=\" +\n        dataSource +\n        \"&token=\" +\n        token;\n      var formData = new FormData();\n      formData.append(\"ndjson\", rowsToNDJSON(events));\n\n      fetch(url, {\n        method: \"POST\",\n        body: formData,\n      })\n        .then(function (r) {\n          return r.json();\n        })\n        .then(function (res) {\n          if (res) {\n            events = [];\n            storage.setItem(STORAGE_ITEM, \"[]\");\n            delayUpload(TIMEOUT, MAX_RETRIES);\n          } else {\n            onError();\n          }\n          uploading = false;\n        })\n        .catch(function () {\n          onError();\n        });\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES);\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries);\n    }, t);\n  }\n\n  function addEvent(eventName, eventProps) {\n    var ev = eventProps || {};\n    ev[\"event\"] = eventName || \"\";\n    ev[\"date\"] = dateFormatted();\n    ev[\"session\"] = session;\n    ev[\"uuid\"] = userCookie;\n\n    events.push(ev);\n\n    // If the event is pageload, don't wait to the flush\n    if (eventName === \"pageload\") {\n      uploadEvents(MAX_RETRIES);\n    }\n  }\n\n  function die() {\n    storage.setItem(STORAGE_ITEM, JSON.stringify(events));\n    uploadEvents();\n  }\n\n  w.addEventListener(\"beforeunload\", die);\n  w.addEventListener(\"unload\", die, false);\n\n  // Overwritte tinybird function\n  w.tinybird = addEvent;\n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES);\n\n  /**\n   * utility methods\n   */\n\n  function rowsToNDJSON(events) {\n    const stringEvents = events.map((e) => JSON.stringify(e));\n    return stringEvents.join(\"\\n\") + \"\\n\";\n  }\n\n  function dateFormatted(d) {\n    d = d || new Date();\n    return d.toISOString().replace(\"T\", \" \").split(\".\")[0];\n  }\n\n  function uuidv4() {\n    return \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(\n      /[xy]/g,\n      function (c) {\n        var r = (Math.random() * 16) | 0;\n        var v = c == \"x\" ? r : (r & 0x3) | 0x8;\n        return v.toString(16);\n      }\n    );\n  }\n\n  function setCookie(name, value) {\n    document.cookie = name + \"=\" + (value || \"\") + \"; path=/\";\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + \"=\";\n    var ca = document.cookie.split(\";\");\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i];\n      while (c.charAt(0) === \" \") {\n        c = c.substring(1, c.length);\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length);\n      }\n    }\n    return null;\n  }\n\n  function getParameterByName(name) {\n    return currentScript.getAttribute(\"data-\" + name);\n  }\n};\n\ntracker(window);\n\nexport default tracker;\n","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(s.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.module.js.map\n"],"names":["tracker","w","storage","localStorage","currentScript","document","api","getParameterByName","URL","src","origin","dataSource","token","Error","STORAGE_ITEM","TIMEOUT","userCookie","name","nameEQ","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","addEventListener","die","tinybird","eventName","eventProps","ev","push","uploadEvents","delayUpload","n","url","formData","FormData","append","map","e","stringify","join","rowsToNDJSON","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","then","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","res","setItem","onError","catch","retries","setTimeout","d","Date","toISOString","getAttribute","window"],"mappings":"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"}