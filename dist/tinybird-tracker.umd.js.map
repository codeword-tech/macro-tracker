{"version":3,"file":"tinybird-tracker.umd.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\r\n\r\nvar tracker = (function () {\r\n  var TRACKER_COLUMNS = 14\r\n  var COOKIE_NAME = '_track'\r\n  var LOCAL_STORAGE = this.localStorage\r\n  var STORAGE_ITEM = 'tinybird_events'\r\n  var DATASOURCE_NAME = 'tracker'\r\n  var ACCOUNT_NAME = 'main'\r\n  var MAX_RETRIES = 5\r\n  var TIMEOUT = 2000\r\n  var DEFAULT_FUNCTION_NAME = 'tbt'\r\n  var HOST = 'https://api.tinybird.co'\r\n\r\n  var token\r\n  var accountName\r\n  var datasourceName\r\n  var functionName\r\n  var host\r\n  \r\n  var userCookie = getCookie(COOKIE_NAME)\r\n  var events = JSON.parse(LOCAL_STORAGE.getItem(STORAGE_ITEM) || '[]')\r\n  var session = dateFormatted()\r\n  var uploading = false\r\n\r\n  if (!userCookie) {\r\n    userCookie = uuidv4()\r\n    setCookie(COOKIE_NAME, userCookie)\r\n  }\r\n  \r\n  function init() {\r\n    if (!getParameterByName('t')) {\r\n      throw new Error('token is needed for sending events') \r\n    }\r\n\r\n    token = decodeURIComponent(getParameterByName('t'))\r\n    accountName = getParameterByName('a') || ACCOUNT_NAME\r\n    functionName = getParameterByName('f') || DEFAULT_FUNCTION_NAME\r\n    datasourceName = getParameterByName('d') || DATASOURCE_NAME\r\n    host = decodeURIComponent(getParameterByName('h')) || HOST\r\n  }\r\n\r\n  function uploadEvents(n) {\r\n    if (uploading) return\r\n\r\n    function onError () {\r\n      if (n > 0) {\r\n        // set uploading to false to allow recheck\r\n        uploading = false\r\n        delayUpload(TIMEOUT, n - 1)\r\n      }\r\n    }\r\n\r\n    if (events.length > 0) {\r\n      uploading = true\r\n      \r\n      var url = host +\r\n        '/v0/datasources?mode=append&name=' + datasourceName +\r\n        '&token=' + token\r\n      var formData = new FormData()\r\n      formData.append('csv', rowsToCSV(events))\r\n\r\n      fetch(url, {\r\n        method: 'POST',\r\n        body: formData\r\n      })\r\n      .then(function (r) {\r\n        return r.json()\r\n      })\r\n      .then(function (res) {\r\n        if (res) {\r\n          events = []\r\n          LOCAL_STORAGE.setItem(STORAGE_ITEM, '[]')\r\n          delayUpload(TIMEOUT, MAX_RETRIES)\r\n        } else {\r\n          onError()\r\n        }\r\n        uploading = false\r\n      })\r\n      .catch(function () {\r\n        onError()\r\n      })\r\n    } else {\r\n      delayUpload(TIMEOUT, MAX_RETRIES)\r\n    }\r\n  }\r\n\r\n  function delayUpload(t, retries) {\r\n    setTimeout(function () {\r\n      uploadEvents(retries)\r\n    }, t)\r\n  }\r\n\r\n  function flush() {\r\n    uploadEvents()\r\n  }\r\n\r\n  function addEvent() {\r\n    var argsArray = Array.prototype.slice.call(arguments)[0]\r\n    var ev = [\r\n      dateFormatted(),\r\n      session,\r\n      accountName,\r\n      userCookie,\r\n      document.location.href,\r\n      navigator.userAgent\r\n    ].concat(argsArray)\r\n    if (ev.length < TRACKER_COLUMNS) {\r\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\r\n    }\r\n    events.push(ev)\r\n\r\n    // If the event is pageload, don't wait to the flush\r\n    if(argsArray[0] === 'pageload') {\r\n      uploadEvents()\r\n    }\r\n  }\r\n\r\n  function parseItems(items) {\r\n    function parseItem(item) {\r\n      if (!Array.isArray(item)) {\r\n        throw new Error('Only array events are allowed')\r\n      }\r\n      addEvent(item)\r\n    }\r\n\r\n    if (!items) {\r\n      return\r\n    }\r\n\r\n    if (!Array.isArray(items)) {\r\n      throw new Error('Events can only be sent as an array')\r\n    }\r\n\r\n    for (var i = 0, l = items.length; i < l; i++) {\r\n      parseItem(Array.prototype.slice.call(items[i]))\r\n    }\r\n  }\r\n\r\n  function die() {\r\n    LOCAL_STORAGE.setItem(STORAGE_ITEM, JSON.stringify(events))\r\n    uploadEvents()\r\n  }\r\n\r\n  this.addEventListener('beforeunload', die)\r\n  this.addEventListener('unload', die, false)\r\n\r\n  // Initialize tracker\r\n  init()\r\n\r\n  // Parse first what tbt contains\r\n  parseItems(this[functionName])\r\n\r\n  // Overwritte tbt.push function\r\n  this[functionName] = {\r\n    push: function (item) {\r\n      var items\r\n      if (arguments.length > 1) {\r\n        items = Array.prototype.slice.call(arguments)\r\n      } else {\r\n        items = [item]\r\n      }\r\n\r\n      parseItems(items)\r\n    }\r\n  } \r\n\r\n  // Start upload\r\n  delayUpload(TIMEOUT, MAX_RETRIES)\r\n  \r\n  /**\r\n   * utility methods\r\n   */\r\n\r\n  function dateFormatted(d) {\r\n    d = d || new Date()\r\n    return d.toISOString().replace('T', ' ').split('.')[0]\r\n  }\r\n\r\n  function setCookie(name, value) {\r\n    document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\r\n  }\r\n\r\n  function uuidv4() {\r\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n      var r = Math.random() * 16 | 0\r\n      var v = c == 'x' ? r : (r & 0x3 | 0x8)\r\n      return v.toString(16)\r\n    })\r\n  }\r\n\r\n  function getCookie(name) {\r\n    var nameEQ = name + \"=\"\r\n    var ca = document.cookie.split(';')\r\n    for (var i = 0; i < ca.length; ++i) {\r\n      var c = ca[i]\r\n      while (c.charAt(0) === ' ') {\r\n        c = c.substring(1, c.length)\r\n      }\r\n      if (c.indexOf(nameEQ) === 0) {\r\n        return c.substring(nameEQ.length, c.length)\r\n      }\r\n    }\r\n    return null\r\n  }\r\n\r\n  function rowsToCSV(rows) {\r\n    var escapeQuotes = function (str) {\r\n      return str.replace(/\\\"/g, '\"\"')\r\n    }\r\n\r\n    return rows.map(function (r) {\r\n      return r.map(function (field) {\r\n        if (typeof(field) === 'string') {\r\n          field = escapeQuotes(field)\r\n          if (field[0] !== '\"' || field[field.length - 1] !== '\"') {\r\n            field = '\"' + field  + '\"'\r\n          }\r\n          return field\r\n        }\r\n        return field\r\n      }).join(',')\r\n    }).join('\\n')\r\n  }\r\n\r\n  function getParameterByName(name, url) {\r\n    if (!url) url = document.currentScript && document.currentScript.src ||Â '';\r\n    name = name.replace(/[\\[\\]]/g, '\\\\$&');\r\n    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),\r\n        results = regex.exec(url);\r\n    if (!results) return null;\r\n    if (!results[2]) return '';\r\n    return decodeURIComponent(results[2].replace(/\\+/g, ' '));\r\n}\r\n})(window)\r\n\r\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["token","accountName","datasourceName","functionName","host","LOCAL_STORAGE","this","localStorage","userCookie","name","ca","document","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","uploadEvents","n","url","formData","FormData","append","map","r","field","replace","join","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","setItem","delayUpload","onError","retries","setTimeout","parseItems","items","parseItem","item","Array","isArray","Error","argsArray","prototype","slice","call","arguments","ev","location","href","navigator","userAgent","concat","fill","addEvent","die","stringify","d","Date","toISOString","getParameterByName","currentScript","src","results","RegExp","exec","decodeURIComponent","Math","random","toString","addEventListener","init"],"mappings":"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"}