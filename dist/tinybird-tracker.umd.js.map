{"version":3,"file":"tinybird-tracker.umd.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\r\n\r\nconst TRACKER_COLUMNS = 14\r\nconst cookieName = '_track'\r\nconst localStorage = window.localStorage\r\nconst storageItem = 'tinybird_events'\r\nconst datasourceName = 'tracker'\r\nconst MAX_RETRIES = 5\r\nconst TIMEOUT = 2000\r\n\r\n/**\r\n * install a tracker for the user\r\n */\r\nfunction tracker(token, accountName, globalFunctionName, host) {\r\n  globalFunctionName = globalFunctionName || 'tracker_ga'\r\n  let userCookie = getCookie(cookieName)\r\n\r\n  if (!userCookie) {\r\n    userCookie = uuidv4()\r\n    setCookie(cookieName, userCookie)\r\n  }\r\n\r\n  const session = dateFormatted()\r\n  let events = JSON.parse(localStorage.getItem(storageItem) || '[]')\r\n\r\n  var uploading = false\r\n  function uploadEvents(n) {\r\n    if (uploading) return\r\n\r\n    if (events.length > 0) {\r\n      uploading = true\r\n      fetch(`${host ||Â 'https://api.tinybird.co'}/v0/datasources?mode=append&name=${datasourceName}&token=${token}`, {\r\n        method: 'POST'\r\n      })\r\n      .then(r => r.json())\r\n      .then(res => {\r\n        if (res && !res.error) {\r\n          events = []\r\n          window.localStorage.setItem(storageItem, '[]')\r\n          delayUpload(TIMEOUT, MAX_RETRIES)\r\n        } else {\r\n          if (n > 0) {\r\n            // set uploading to false to allow recheck\r\n            uploading = false\r\n            delayUpload(TIMEOUT, n - 1)\r\n          }\r\n        }\r\n        uploading = false\r\n      })\r\n      .catch(() => {\r\n        if (n > 0) {\r\n          // set uploading to false to allow recheck\r\n          uploading = false\r\n          delayUpload(TIMEOUT, n - 1)\r\n        }\r\n      })\r\n    } else {\r\n      delayUpload(TIMEOUT, MAX_RETRIES)\r\n    }\r\n  }\r\n\r\n  function delayUpload(t, retries) {\r\n    setTimeout(function () {\r\n      uploadEvents(retries)\r\n    }, t)\r\n  }\r\n\r\n  delayUpload(TIMEOUT, MAX_RETRIES)\r\n\r\n  tracker.flush = uploadEvents\r\n\r\n  window[globalFunctionName] = function () {\r\n    let ev = [dateFormatted(), session, accountName, userCookie, document.location.href, navigator.userAgent].concat(Array.prototype.slice.call(arguments))\r\n    if (ev.length < TRACKER_COLUMNS) {\r\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\r\n    }\r\n    events.push(ev)\r\n\r\n    // when the event is pageload send it right awat, do not wait to the flush\r\n    if(arguments[0] === 'pageload') {\r\n      uploadEvents();\r\n    }\r\n  }\r\n\r\n  function die() {\r\n    localStorage.setItem(storageItem, JSON.stringify(events))\r\n    uploadEvents()\r\n  }\r\n\r\n  window.addEventListener('beforeunload', die)\r\n  window.addEventListener('unload', die, false)\r\n}\r\n\r\n/**\r\n * utility methods\r\n */\r\n\r\nfunction dateFormatted(d) {\r\n  d = d || new Date()\r\n  return d.toISOString().replace('T', ' ').split('.')[0]\r\n}\r\n\r\nfunction setCookie(name, value) {\r\n  document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\r\n}\r\n\r\nfunction uuidv4() {\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n    const r = Math.random() * 16 | 0\r\n    const v = c == 'x' ? r : (r & 0x3 | 0x8)\r\n    return v.toString(16)\r\n  })\r\n}\r\n\r\nfunction getCookie(name) {\r\n  const nameEQ = name + \"=\"\r\n  const ca = document.cookie.split(';')\r\n  for (let i = 0; i < ca.length; ++i) {\r\n    let c = ca[i]\r\n    while (c.charAt(0) === ' ') {\r\n      c = c.substring(1, c.length)\r\n    }\r\n    if (c.indexOf(nameEQ) === 0) {\r\n      return c.substring(nameEQ.length, c.length)\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["localStorage","window","dateFormatted","d","Date","toISOString","replace","split","tracker","token","accountName","globalFunctionName","host","userCookie","name","ca","document","cookie","i","length","c","charAt","substring","indexOf","getCookie","r","Math","random","toString","session","events","JSON","parse","getItem","uploading","uploadEvents","n","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","url","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","push","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","error","setItem","delayUpload","retries","setTimeout","die","stringify","flush","ev","location","href","navigator","userAgent","concat","Array","prototype","slice","call","arguments","fill","addEventListener"],"mappings":"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"}