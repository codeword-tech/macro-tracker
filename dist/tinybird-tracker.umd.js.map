{"version":3,"file":"tinybird-tracker.umd.js","sources":["../src/tracker.js","../node_modules/unfetch/dist/unfetch.mjs"],"sourcesContent":["import fetch from 'unfetch'\n\nvar tracker = (function (w) {\n  if (!w || !w.document.currentScript) {\n    return\n  }\n\n  var TRACKER_COLUMNS = 14\n  var COOKIE_NAME = '_track'\n  var LOCAL_STORAGE = w.localStorage\n  var STORAGE_ITEM = 'tinybird_events'\n  var DATASOURCE_NAME = 'tracker'\n  var ACCOUNT_NAME = 'main'\n  var MAX_RETRIES = 5\n  var TIMEOUT = 2000\n  var DEFAULT_FUNCTION_NAME = 'tbt'\n  var HOST = 'https://api.tinybird.co'\n\n  var token\n  var accountName\n  var datasourceName\n  var functionName\n  var host\n  \n  var userCookie = getCookie(COOKIE_NAME)\n  var events = JSON.parse(LOCAL_STORAGE.getItem(STORAGE_ITEM) || '[]')\n  var session = dateFormatted()\n  var uploading = false\n\n  if (!userCookie) {\n    userCookie = uuidv4()\n    setCookie(COOKIE_NAME, userCookie)\n  }\n  \n  function init() {\n    if (!getParameterByName('t')) {\n      throw new Error('token is needed for sending events') \n    }\n\n    token = decodeURIComponent(getParameterByName('t'))\n    accountName = getParameterByName('a') || ACCOUNT_NAME\n    functionName = getParameterByName('f') || DEFAULT_FUNCTION_NAME\n    datasourceName = getParameterByName('d') || DATASOURCE_NAME\n    host = getParameterByName('h') && decodeURIComponent(getParameterByName('h')) || HOST\n  }\n\n  function uploadEvents(n) {\n    if (uploading) return\n\n    function onError () {\n      if (n > 0) {\n        // set uploading to false to allow recheck\n        uploading = false\n        delayUpload(TIMEOUT, n - 1)\n      }\n    }\n\n    if (events.length > 0) {\n      uploading = true\n      \n      var url = host +\n        '/v0/datasources?mode=append&name=' + datasourceName +\n        '&token=' + token\n      var formData = new FormData()\n      formData.append('csv', rowsToCSV(events))\n\n      fetch(url, {\n        method: 'POST',\n        body: formData\n      })\n      .then(function (r) {\n        return r.json()\n      })\n      .then(function (res) {\n        if (res) {\n          events = []\n          LOCAL_STORAGE.setItem(STORAGE_ITEM, '[]')\n          delayUpload(TIMEOUT, MAX_RETRIES)\n        } else {\n          onError()\n        }\n        uploading = false\n      })\n      .catch(function () {\n        onError()\n      })\n    } else {\n      delayUpload(TIMEOUT, MAX_RETRIES)\n    }\n  }\n\n  function delayUpload(t, retries) {\n    setTimeout(function () {\n      uploadEvents(retries)\n    }, t)\n  }\n\n  function flush() {\n    uploadEvents()\n  }\n\n  function addEvent() {\n    var argsArray = Array.prototype.slice.call(arguments)[0]\n    var ev = [\n      dateFormatted(),\n      session,\n      accountName,\n      userCookie,\n      document.location.href,\n      navigator.userAgent\n    ].concat(argsArray)\n    if (ev.length < TRACKER_COLUMNS) {\n      ev = ev.concat(Array(TRACKER_COLUMNS - ev.length).fill(''))\n    }\n    events.push(ev)\n\n    // If the event is pageload, don't wait to the flush\n    if(argsArray[0] === 'pageload') {\n      uploadEvents()\n    }\n  }\n\n  function parseItems(items) {\n    function parseItem(item) {\n      if (!Array.isArray(item)) {\n        throw new Error('Only array events are allowed')\n      }\n      addEvent(item)\n    }\n\n    if (!items) {\n      return\n    }\n\n    if (!Array.isArray(items)) {\n      throw new Error('Events can only be sent as an array')\n    }\n\n    for (var i = 0, l = items.length; i < l; i++) {\n      parseItem(Array.prototype.slice.call(items[i]))\n    }\n  }\n\n  function die() {\n    LOCAL_STORAGE.setItem(STORAGE_ITEM, JSON.stringify(events))\n    uploadEvents()\n  }\n\n  w.addEventListener('beforeunload', die)\n  w.addEventListener('unload', die, false)\n\n  // Initialize tracker\n  init()\n\n  // Parse first what tbt contains\n  parseItems(w[functionName])\n\n  // Overwritte tbt.push function\n  w[functionName] = {\n    push: function (item) {\n      var items\n      if (arguments.length > 1) {\n        items = Array.prototype.slice.call(arguments)\n      } else {\n        items = [item]\n      }\n\n      parseItems(items)\n    }\n  } \n\n  // Start upload\n  delayUpload(TIMEOUT, MAX_RETRIES)\n  \n  /**\n   * utility methods\n   */\n\n  function dateFormatted(d) {\n    d = d || new Date()\n    return d.toISOString().replace('T', ' ').split('.')[0]\n  }\n\n  function setCookie(name, value) {\n    document.cookie = name + \"=\" + (value || \"\") + \"; path=/\"\n  }\n\n  function uuidv4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0\n      var v = c == 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  }\n\n  function getCookie(name) {\n    var nameEQ = name + \"=\"\n    var ca = document.cookie.split(';')\n    for (var i = 0; i < ca.length; ++i) {\n      var c = ca[i]\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1, c.length)\n      }\n      if (c.indexOf(nameEQ) === 0) {\n        return c.substring(nameEQ.length, c.length)\n      }\n    }\n    return null\n  }\n\n  function rowsToCSV(rows) {\n    var escapeQuotes = function (str) {\n      return str.replace(/\\\"/g, '\"\"')\n    }\n\n    return rows.map(function (r) {\n      return r.map(function (field) {\n        if (typeof(field) === 'string') {\n          field = escapeQuotes(field)\n          if (field[0] !== '\"' || field[field.length - 1] !== '\"') {\n            field = '\"' + field  + '\"'\n          }\n          return field\n        }\n        return field\n      }).join(',')\n    }).join('\\n')\n  }\n\n  function getParameterByName(name, url) {\n    if (!url) url = w.document.currentScript && w.document.currentScript.src || '';\n    name = name.replace(/[\\[\\]]/g, '\\\\$&');\n    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),\n        results = regex.exec(url);\n    if (!results) return null;\n    if (!results[2]) return '';\n    return decodeURIComponent(results[2].replace(/\\+/g, ' '));\n  }\n})\n\ntracker(window)\n\nexport default tracker","export default function(e,n){return n=n||{},new Promise(function(t,r){var s=new XMLHttpRequest,o=[],u=[],i={},a=function(){return{ok:2==(s.status/100|0),statusText:s.statusText,status:s.status,url:s.responseURL,text:function(){return Promise.resolve(s.responseText)},json:function(){return Promise.resolve(JSON.parse(s.responseText))},blob:function(){return Promise.resolve(new Blob([s.response]))},clone:a,headers:{keys:function(){return o},entries:function(){return u},get:function(e){return i[e.toLowerCase()]},has:function(e){return e.toLowerCase()in i}}}};for(var l in s.open(n.method||\"get\",e,!0),s.onload=function(){s.getAllResponseHeaders().replace(/^(.*?):[^\\S\\n]*([\\s\\S]*?)$/gm,function(e,n,t){o.push(n=n.toLowerCase()),u.push([n,t]),i[n]=i[n]?i[n]+\",\"+t:t}),t(a())},s.onerror=r,s.withCredentials=\"include\"==n.credentials,n.headers)s.setRequestHeader(l,n.headers[l]);s.send(n.body||null)})}\n//# sourceMappingURL=unfetch.mjs.map\n"],"names":["tracker","w","document","currentScript","token","accountName","datasourceName","functionName","host","LOCAL_STORAGE","localStorage","userCookie","name","ca","cookie","split","i","length","c","charAt","substring","indexOf","getCookie","events","JSON","parse","getItem","session","dateFormatted","uploading","replace","r","Math","random","toString","addEventListener","die","getParameterByName","Error","decodeURIComponent","init","parseItems","push","item","arguments","Array","prototype","slice","call","delayUpload","uploadEvents","n","url","formData","FormData","append","map","field","join","e","Promise","t","s","XMLHttpRequest","o","u","a","ok","status","statusText","responseURL","text","resolve","responseText","json","blob","Blob","response","clone","headers","keys","entries","get","toLowerCase","has","l","open","method","onload","getAllResponseHeaders","onerror","withCredentials","credentials","setRequestHeader","send","body","fetch","then","res","setItem","onError","catch","retries","setTimeout","items","parseItem","isArray","argsArray","ev","location","href","navigator","userAgent","concat","fill","addEvent","stringify","d","Date","toISOString","src","results","RegExp","exec","window"],"mappings":"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"}